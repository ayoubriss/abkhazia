#!/bin/bash -u
# Copyright 2015, 2016 Thomas Schatz, Xuan Nga Cao, Mathieu Bernard
#
# This file is part of abkhazia: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Abkhazia is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with abkahzia. If not, see <http://www.gnu.org/licenses/>.

# This is a simple kaldi recipe for use with the abkhazia library.
# Its main object is to compute a forced time-alignment from language
# model and acoustic model trained on an abkhazia corpus.

###### Parameters ######

# language model directory in the recipe
lang=@@@@

# acoustic model directory in the recipe TODO only from a triphone
# speaker adapted model for now.  What we need from the directory:
# {tree,final}.mdl, final.alimdl, final.occs, splice_opts, cmvn_opts,
# delta_opts, final.mat, full.mat
acoustic=@@@@


[[ -z $acoustic/final.mdl ]] && \
    (echo "non valid acoustic model, $acoustic/final.mdl not found"; exit 1)

###### Recipe ######

[ -f cmd.sh ] && source ./cmd.sh \
  || echo "cmd.sh not found. Jobs may not execute properly."

. path.sh || { echo "Cannot source path.sh"; exit 1; }


# Final forced alignment
mkdir -p exp/tri2a_ali_fmllr
steps/align_fmllr.sh \
    --nj 1 --cmd "$train_cmd" \
    data/main data/$lang exp/tri2a exp/tri2a_ali_fmllr \
    >& exp/tri2a_ali_fmllr/align.log


##### Exporting results #####

echo "exporting results to export/forced_alignment.tra"
mkdir -p export
ali-to-phones \
    --write_lengths=true exp/tri2a/final.mdl \
    "ark,t:gunzip -c exp/tri2a_ali_fmllr/ali.1.gz|" \
    ark,t:export/forced_alignment.tra

# if we want to use the tri2a results directly without the final
# forced alignment (is there any difference between the two beyond one
# being done using only one job?)
# ali-to-phones \
#     --write_lengths=true exp/tri2a/final.mdl \
#     "ark,t:gunzip -c exp/tri2a/ali.*.gz|" \
#     ark,t:export/forced_alignment.tra
