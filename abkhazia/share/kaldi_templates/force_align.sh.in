#!/bin/bash -u
# Copyright 2015, 2016 Thomas Schatz, Xuan Nga Cao, Mathieu Bernard
#
# This file is part of abkhazia: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Abkhazia is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with abkahzia. If not, see <http://www.gnu.org/licenses/>.

# This is a simple kaldi recipe for use with the abkhazia library.
# Its main object is to compute a forced time-alignment from language
# model and acoustic model trained on an abkhazia corpus.

###### Parameters ######

# language model directory in the recipe
lang=@@@@

# acoustic model directory in the recipe
acoustic=@@@@

# number of parallel jobs
njobs=@@@@


# [[ -z $acoustic/final.mdl ]] && \
#     (echo "non valid acoustic model, $acoustic/final.mdl not found"; exit 1)

###### Recipe ######

[ -f cmd.sh ] && source ./cmd.sh \
  || echo "cmd.sh not found. Jobs may not execute properly."

. path.sh || { echo "Cannot source path.sh"; exit 1; }


# Final forced alignment
echo -n "computing forced alignment (log in exp/ali_fmllr/align.log)..."
mkdir -p exp/ali_fmllr
steps/align_fmllr.sh \
    --nj $njobs --cmd "$train_cmd" \
    data/align $lang $acoustic exp/ali_fmllr \
    >& exp/ali_fmllr/align.log || { echo failed; exit 1; }
echo done


##### Exporting results #####

echo "exporting results to export/forced_alignment.tra (log in exp/ali_fmllr/export.log)"
mkdir -p export
ali-to-phones \
    --write_lengths=true $acoustic/final.mdl \
    "ark,t:gunzip -c exp/ali_fmllr/ali.1.gz|" \
    ark,t:export/forced_alignment.tra \
    >& exp/ali_fmllr/export.log || exit 1

# if we want to use the tri2a results directly without the final
# forced alignment (is there any difference between the two beyond one
# being done using only one job?)
# ali-to-phones \
#     --write_lengths=true exp/tri2a/final.mdl \
#     "ark,t:gunzip -c exp/tri2a/ali.*.gz|" \
#     ark,t:export/forced_alignment.tra
